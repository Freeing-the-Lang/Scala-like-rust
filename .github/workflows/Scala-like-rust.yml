name: "ğŸ¦€ Scala-like-Rust â€” Fusion Build (v2.0 / Open Branch + Auto Contributor Update)"

on:
  push:
    branches: [ "**" ]  # ëª¨ë“  ë¸Œëœì¹˜ í—ˆìš© (ë¸Œëœì¹˜ ê°œë°©)
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: scala-like-rust-${{ github.ref }}
  cancel-in-progress: false  # ì—¬ëŸ¬ ë¸Œëœì¹˜ ë¹Œë“œ í—ˆìš©

jobs:
  build-3os:
    name: "Build & Release (${{ matrix.os }})"
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ğŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ğŸ”§ Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "ğŸ› ï¸ Build Project"
        run: cargo build --release

      - name: "ğŸ“¦ Collect Executable"
        shell: bash
        run: |
          mkdir -p dist
          if [ -f target/release/scala_like_rust ]; then
            cp target/release/scala_like_rust dist/
          elif [ -f target/release/scala_like_rust.exe ]; then
            cp target/release/scala_like_rust.exe dist/
          else
            echo "âš ï¸ Binary not found."
            exit 1
          fi

      - name: "ğŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          echo "ğŸ§¾ Generating ProofLedger..."
          cd dist
          sha256sum scala_like_rust* > PROOF_LEDGER.txt 2>/dev/null || shasum -a 256 scala_like_rust* > PROOF_LEDGER.txt
          echo "Commit: $GITHUB_SHA" >> PROOF_LEDGER.txt
          date -u +"Build UTC: %Y-%m-%dT%H:%M:%SZ" >> PROOF_LEDGER.txt
          cat PROOF_LEDGER.txt

      - name: "ğŸ“– Update README Contributors"
        if: github.ref == 'refs/heads/main' || startsWith(github.ref, 'refs/heads/')
        shell: bash
        run: |
          echo "ğŸ“– Updating README.md..."
          CONTRIBUTORS=$(git shortlog -sn --no-merges | awk '{$1=""; print substr($0,2)}')
          echo "## ğŸ‘¥ Contributors" > CONTRIBUTORS.md
          echo "$CONTRIBUTORS" >> CONTRIBUTORS.md
          if grep -q "## ğŸ‘¥ Contributors" README.md; then
            awk '/## ğŸ‘¥ Contributors/{exit}1' README.md > TMP_README.md
            cat CONTRIBUTORS.md >> TMP_README.md
            mv TMP_README.md README.md
          else
            echo -e "\n## ğŸ‘¥ Contributors\n$CONTRIBUTORS" >> README.md
          fi
          rm -f CONTRIBUTORS.md
          git config --global user.name "GitHub Action"
          git config --global user.email "action@github.com"
          git add README.md
          git commit -m "ğŸ¤ Update contributor list [skip ci]" || echo "No changes."
          git push || echo "Push skipped (no token)."

      - name: "ğŸš€ Release (Auto for main)"
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v2.0.${{ github.run_number }}
          name: "Scala-like-Rust Release #${{ github.run_number }}"
          body: |
            ğŸ¦€ Scala-like-Rust â€” Open Branch Edition  
            - âœ… Multi-branch build support  
            - ğŸ§¾ ProofLedger (SHA + Commit + UTC)  
            - ğŸ‘¥ Auto-updated README contributor list  
            - ğŸ’» Full 3OS support  
          files: |
            dist/**
