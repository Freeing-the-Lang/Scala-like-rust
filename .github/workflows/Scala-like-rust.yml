name: "ðŸ¦€ Scala-like-Rust â€” Fusion Build (v1.0 / Full 3OS)"

on:
  push:
    branches: [ main ]
  pull_request:
    types: [ closed ]
  schedule:
    - cron: "0 0 * * *"
  workflow_dispatch:

permissions:
  contents: write

concurrency:
  group: scala-like-rust-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build-3os:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]

    steps:
      - name: "ðŸ§­ Checkout Repository"
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: "ðŸ”§ Setup Rust"
        uses: dtolnay/rust-toolchain@stable

      - name: "ðŸ› ï¸ Build Project"
        run: cargo build --release

      - name: "ðŸ“¦ Collect Executable (cross-platform)"
        shell: bash
        run: |
          mkdir -p dist
          if [ -f target/release/scala_like_rust ]; then
            cp target/release/scala_like_rust dist/
          elif [ -f target/release/scala_like_rust.exe ]; then
            cp target/release/scala_like_rust.exe dist/
          else
            echo "âš ï¸ Binary not found."
            exit 1
          fi

      - name: "ðŸ§¾ Generate ProofLedger"
        shell: bash
        run: |
          echo "ðŸ§¾ Generating ProofLedger..."
          cd dist
          sha256sum scala_like_rust* > PROOF_LEDGER.txt 2>/dev/null || shasum -a 256 scala_like_rust* > PROOF_LEDGER.txt
          echo "Commit: $GITHUB_SHA" >> PROOF_LEDGER.txt
          date -u +"Build UTC: %Y-%m-%dT%H:%M:%SZ" >> PROOF_LEDGER.txt
          cat PROOF_LEDGER.txt

      - name: "ðŸš€ Release (Auto)"
        uses: softprops/action-gh-release@v1
        if: github.ref == 'refs/heads/main'
        with:
          tag_name: v1.0.${{ github.run_number }}
          name: "Scala-like-Rust Release #${{ github.run_number }}"
          body: |
            ðŸ¦€ Scala-like-Rust â€” Fusion Edition  
            - âœ… 3OS Build (Linux / macOS / Windows)  
            - ðŸ§¾ ProofLedger with commit SHA + UTC timestamp  
            - ðŸ§© Functional + Object semantics  
          files: |
            dist/**
